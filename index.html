<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>CasualMITEC — Worker Portal</title>
<meta name="description" content="MITEC casual worker portal — quick start guide, announcements and fast access links." />
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" crossorigin="anonymous">

<style>
  :root{
    --blue:#003366; --mid:#006699; --gold:#D4AF37;
    --bg:#f5f7fb; --card:#ffffff; --muted:#53606a; --radius:12px;
    --container:1100px; --gap:18px;
  }
  html,body{height:100%}
  body{
    margin:0; font-family:Inter,system-ui,Segoe UI,Roboto,Arial; background:var(--bg); color:#162029;
    -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
  }
  .wrap{max-width:var(--container); margin:28px auto; padding:20px;}
  header.site{
    display:flex; gap:12px; align-items:center; justify-content:space-between;
    background:linear-gradient(90deg,var(--blue),var(--mid)); color:#fff;
    padding:18px; border-radius:14px; box-shadow:0 8px 28px rgba(3,22,45,0.12);
  }
  .brand{display:flex; align-items:center; gap:12px}
  .logo{width:56px;height:56px;border-radius:10px;display:grid;place-items:center;font-weight:700;background:rgba(255,255,255,0.08)}
  header h1{margin:0;font-size:1.05rem}
  header p{margin:0; opacity:0.95; font-size:0.92rem}

  main {margin-top:20px; display:grid; gap:var(--gap)}
  .top-grid{display:grid; grid-template-columns: 1fr 360px; gap:var(--gap);}
  @media (max-width:980px){ .top-grid{grid-template-columns:1fr} }

  .card{background:var(--card); border-radius:var(--radius); padding:18px; box-shadow:0 6px 20px rgba(8,20,32,0.04);}

  .qs-title{display:flex; align-items:center; gap:10px; color:var(--blue); font-weight:700; margin-bottom:12px;}
  .steps{display:grid; grid-template-columns:repeat(4,1fr); gap:12px}
  @media(max-width:760px){ .steps{grid-template-columns:repeat(2,1fr)} }
  .step{border:1px solid #e8eef6;border-radius:10px;padding:12px;text-align:center;background:linear-gradient(#fff,#fbfdff)}
  .n{width:44px;height:44px;border-radius:9px;margin:0 auto 8px;background:var(--mid); color:#fff; display:grid; place-items:center; font-weight:700}

  .ann-head{display:flex; gap:12px; align-items:center; justify-content:space-between}
  .ann-controls{display:flex; gap:10px; align-items:center}
  .search{padding:8px 12px;border-radius:8px;border:1px solid #e6ecf3; min-width:180px}
  .ann-list{display:flex;flex-direction:column; gap:10px; margin-top:12px}
  .ann-item{border-left:4px solid var(--gold); background:#fffdf6;padding:12px;border-radius:8px;box-shadow:0 2px 8px rgba(10,20,30,0.03)}
  .ann-item h4{margin:0;color:var(--blue);font-size:0.98rem}
  .ann-item p{margin:6px 0 0;color:var(--muted);font-size:0.95rem}

  .links-grid{display:flex;flex-wrap:wrap;gap:12px;margin-top:6px}
  .link-btn{display:inline-flex;align-items:center;gap:10px;padding:12px 18px;border-radius:10px;background:linear-gradient(180deg,var(--gold),#b68f2a);color:#062028;text-decoration:none;font-weight:700;min-width:160px;box-shadow:0 8px 20px rgba(30,40,60,0.06)}
  .link-icon{width:28px;height:28px;border-radius:6px;display:grid;place-items:center;background:rgba(0,0,0,0.06)}
  .muted{color:var(--muted)}

  .skeleton {height:12px;background:linear-gradient(90deg,#eee,#f2f2f2,#eee);border-radius:6px;animation:shine 1.2s infinite}
  @keyframes shine{0%{background-position:-200px 0}100%{background-position:200px 0}}

  .row{display:flex;gap:12px;align-items:center}
  .center{text-align:center}
  .error{color:#9b2c2c;background:#fff3f3;padding:10px;border-radius:8px}

  /* --- carousel styles --- */
  .ann-carousel { position:relative; overflow:hidden; margin-top:12px; }
  .ann-slides { display:flex; gap:14px; transition:transform 0.45s cubic-bezier(.2,.9,.2,1); padding:6px; will-change:transform; }
  .ann-card {
    min-width:280px; max-width:640px; flex:0 0 68%; background:#fffdf6; border-left:4px solid var(--gold);
    border-radius:10px; padding:14px; box-shadow:0 6px 20px rgba(10,20,30,0.04);
  }
  @media (max-width:980px){ .ann-card{ flex:0 0 92%; } }
  .ann-card h4{ margin:0; color:var(--blue); font-size:1rem; font-weight:700 }
  .ann-card p{ margin:8px 0 0; color:var(--muted); line-height:1.4; font-size:0.95rem }
  .ann-card small { display:block; margin-top:8px; color:var(--muted); font-size:0.82rem; }

  .ann-nav{ position:absolute; top:50%; transform:translateY(-50%); border:none; background:rgba(0,0,0,0.06);
    width:40px;height:40px;border-radius:8px;display:grid;place-items:center;cursor:pointer; }
  .ann-prev{ left:8px; } .ann-next{ right:8px; }
  .ann-nav i{ color:var(--mid); font-size:14px; }

  .ann-indicators{ display:flex; gap:8px; justify-content:center; margin-top:12px; }
  .ann-indicators button{ width:10px; height:10px; border-radius:50%; border:none; background:#e0e6eb; cursor:pointer; }
  .ann-indicators button[aria-selected="true"]{ background:var(--mid); box-shadow:0 4px 10px rgba(0,0,0,0.08); }

  .ann-slide-skeleton{ min-width:280px; flex:0 0 68%; background:transparent; padding:12px; border-radius:8px; }

  @media (max-width:560px){
    header.site{flex-direction:column; align-items:flex-start}
    .steps{ grid-template-columns:1fr; }
    .link-btn{ width:100%; min-width:0; justify-content:flex-start; padding-left:18px; }
  }
</style>
</head>
<body>
  <div class="wrap">
    <header class="site" role="banner">
      <div class="brand">
        <div class="logo">MITEC</div>
        <div>
          <h1>CasualMITEC — Worker Portal</h1>
          <p>Quick access for sign in/out, schedules and updates</p>
        </div>
      </div>
      <div class="center muted" aria-hidden="true">Need help? HR / Ops</div>
    </header>

    <main role="main">
      <div class="top-grid">
        <section class="card" aria-labelledby="qs-title">
          <div id="qs-title" class="qs-title"><i class="fa-solid fa-rocket" style="color:var(--gold)"></i> Quick Start — 4 steps</div>
          <div class="steps" aria-hidden="false">
            <div class="step"><div class="n">1</div><p><strong>Register</strong><br><span class="muted">Create profile & upload ID</span></p></div>
            <div class="step"><div class="n">2</div><p><strong>Apply</strong><br><span class="muted">Pick available shifts</span></p></div>
            <div class="step"><div class="n">3</div><p><strong>Approve</strong><br><span class="muted">Department confirms</span></p></div>
            <div class="step"><div class="n">4</div><p><strong>Attend</strong><br><span class="muted">Sign in/out & get paid</span></p></div>
          </div>
        </section>

        <aside class="card" aria-labelledby="quicklinks-title">
          <div id="quicklinks-title" class="qs-title"><i class="fa-solid fa-link" style="color:var(--mid)"></i> Quick Access</div>
          <div id="links-grid" class="links-grid">
            <div style="width:160px"><div class="skeleton" style="height:40px;border-radius:8px"></div></div>
            <div style="width:160px"><div class="skeleton" style="height:40px;border-radius:8px"></div></div>
            <div style="width:160px"><div class="skeleton" style="height:40px;border-radius:8px"></div></div>
          </div>
        </aside>
      </div>

      <!-- Announcements Carousel -->
      <section class="card announcements" aria-labelledby="ann-title">
        <div class="ann-head" style="align-items:flex-start;">
          <div id="ann-title" class="qs-title"><i class="fa-solid fa-bullhorn" style="color:var(--mid)"></i> Announcements & updates</div>
          <div class="ann-controls">
            <input id="ann-search" class="search" type="search" placeholder="Search announcements..." aria-label="Search announcements">
            <button id="ann-refresh" class="link-btn" style="background:var(--mid); color:#fff; min-width:auto; padding:8px 12px;">
              <i class="fa-solid fa-arrows-rotate"></i>
            </button>
          </div>
        </div>

        <div id="ann-carousel" class="ann-carousel" aria-roledescription="carousel" aria-label="Announcements carousel">
          <div class="ann-slides" id="ann-slides" role="list">
            <div class="ann-slide-skeleton">
              <div class="skeleton" style="height:18px;width:60%"></div>
              <div style="height:8px"></div>
              <div class="skeleton" style="height:12px;width:90%"></div>
            </div>
            <div class="ann-slide-skeleton">
              <div class="skeleton" style="height:18px;width:50%"></div>
              <div style="height:8px"></div>
              <div class="skeleton" style="height:12px;width:80%"></div>
            </div>
          </div>

          <button class="ann-prev ann-nav" id="ann-prev" aria-label="Previous announcement"><i class="fa-solid fa-chevron-left"></i></button>
          <button class="ann-next ann-nav" id="ann-next" aria-label="Next announcement"><i class="fa-solid fa-chevron-right"></i></button>

          <div class="ann-indicators" id="ann-indicators" role="tablist" aria-label="Announcement pages"></div>
        </div>

        <div id="ann-empty" class="muted" style="margin-top:10px; display:none">No announcements at the moment.</div>
      </section>

    </main>

    <footer style="margin-top:20px;text-align:center;color:var(--muted);font-size:0.9rem">© Malaysia International Trade & Exhibition Centre — CasualMITEC</footer>
  </div>

<script>
/* ===========================
   CONFIG: your sheet IDs
   =========================== */
const ANNOUNCEMENTS_SHEET_ID = "1Gks45PK53pcPJXePjYlRLpAhAmGPMPB3X0ec5XaLgRI";
const LINKS_SHEET_ID         = "1HG6XoahHcLPkwsSH5MwY3I7f-iBX6OXtZX5F1-dyYkg";

/* SETTINGS */
const CACHE_PREFIX = 'casualmitec_v1';
const CACHE_TTL_MS = 1000 * 60 * 5; // 5 minutes
const AUTO_ROTATE_MS = 6000; // carousel auto-rotate

/* helper: fetch google sheet gviz json and parse rows */
async function fetchSheetRows(sheetId, sheetName = 'Sheet1') {
  const url = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(sheetName)}`;
  const r = await fetch(url);
  if(!r.ok) throw new Error('Sheet fetch failed ' + r.status);
  const text = await r.text();
  const json = JSON.parse(text.substr(47).slice(0, -2));
  return json.table.rows || [];
}

/* localStorage caching helpers */
function cacheGet(key){
  try{
    const raw = localStorage.getItem(key);
    if(!raw) return null;
    const parsed = JSON.parse(raw);
    if(Date.now() - parsed._ts > CACHE_TTL_MS){ localStorage.removeItem(key); return null; }
    return parsed.value;
  }catch(e){ return null; }
}
function cacheSet(key, value){
  try{ localStorage.setItem(key, JSON.stringify({ _ts: Date.now(), value })); }catch(e){}
}

/* escape HTML */
function escapeHtml(s=''){ return String(s).replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

/* -- LINKS: load & render -- */
async function loadLinks(){
  const container = document.getElementById('links-grid');
  const cacheKey = CACHE_PREFIX + '_links';
  const cached = cacheGet(cacheKey);
  if(cached){ renderLinks(cached); return; }
  try{
    const rows = await fetchSheetRows(LINKS_SHEET_ID);
    const parsed = rows.map(r => ({ label: r.c && r.c[0] ? r.c[0].v : 'Link', href: r.c && r.c[1] ? r.c[1].v : '#' }));
    cacheSet(cacheKey, parsed);
    renderLinks(parsed);
  }catch(e){
    container.innerHTML = `<div class="error">Unable to load quick links. <button id="links-retry" class="link-btn" style="background:#e6b45c">Retry</button></div>`;
    document.getElementById('links-retry')?.addEventListener('click', ()=> loadLinks());
    console.error(e);
  }
}
function renderLinks(list){
  const container = document.getElementById('links-grid');
  container.innerHTML = '';
  if(!list.length){ container.innerHTML = '<div class="muted">No quick links available.</div>'; return; }
  list.forEach(item=>{
    const a = document.createElement('a');
    a.className = 'link-btn';
    a.href = item.href || '#';
    if(/^https?:\/\//i.test(item.href)) a.target = '_blank';
    a.rel = 'noopener noreferrer';
    a.innerHTML = `<span class="link-icon"><i class="fa-solid fa-arrow-right"></i></span><span>${escapeHtml(item.label)}</span>`;
    container.appendChild(a);
  });
}

/* -- ANNOUNCEMENTS CAROUSEL -- */
let ANNOUNCEMENTS = [];
let carouselTimer = null;
let currentIndex = 0;

const slidesEl = document.getElementById('ann-slides');
const indicatorsEl = document.getElementById('ann-indicators');
const prevBtn = document.getElementById('ann-prev');
const nextBtn = document.getElementById('ann-next');
const emptyEl = document.getElementById('ann-empty');
const searchInput = document.getElementById('ann-search');
const refreshBtn = document.getElementById('ann-refresh');

async function loadAnnouncements(force=false){
  const cacheKey = CACHE_PREFIX + '_anns';
  if(!force){
    const cached = cacheGet(cacheKey);
    if(cached){ ANNOUNCEMENTS = cached; buildSlides(cached); return; }
  }
  try{
    const rows = await fetchSheetRows(ANNOUNCEMENTS_SHEET_ID);
    const parsed = rows.map(r => ({ title: r.c && r.c[0] ? r.c[0].v : '', desc: r.c && r.c[1] ? r.c[1].v : '', date: r.c && r.c[2] ? r.c[2].v : '' }));
    ANNOUNCEMENTS = parsed;
    cacheSet(cacheKey, parsed);
    buildSlides(parsed);
  }catch(e){
    slidesEl.innerHTML = '';
    indicatorsEl.innerHTML = '';
    emptyEl.style.display = 'block';
    emptyEl.textContent = 'Unable to load announcements.';
    console.error(e);
  }
}

function buildSlides(list){
  slidesEl.innerHTML = '';
  indicatorsEl.innerHTML = '';
  if(!list.length){ emptyEl.style.display = 'block'; return; }
  emptyEl.style.display = 'none';
  list.forEach((it, i) => {
    const card = document.createElement('div');
    card.className = 'ann-card';
    card.setAttribute('role','article');
    card.setAttribute('aria-roledescription','slide');
    card.setAttribute('data-index', i);
    const title = it.title || it.desc || `Announcement ${i+1}`;
    const desc  = it.desc ? `<p>${escapeHtml(it.desc)}</p>` : '';
    const date  = it.date ? `<small class="muted">${escapeHtml(it.date)}</small>` : '';
    card.innerHTML = `<h4>${escapeHtml(title)}</h4>${desc}${date}`;
    slidesEl.appendChild(card);

    const ind = document.createElement('button');
    ind.setAttribute('aria-label', `Go to announcement ${i+1}`);
    ind.setAttribute('aria-selected', 'false');
    ind.dataset.index = i;
    ind.addEventListener('click', ()=> showSlide(i));
    indicatorsEl.appendChild(ind);
  });

  showSlide(0);
  startAutoRotate();
}

function showSlide(index){
  const count = slidesEl.children.length;
  if(count === 0) return;
  if(index < 0) index = count - 1;
  if(index >= count) index = 0;
  currentIndex = index;
  const slideWidth = slidesEl.children[0].getBoundingClientRect().width + 14; // gap
  const offset = - (slideWidth * index);
  slidesEl.style.transform = `translateX(${offset}px)`;
  Array.from(indicatorsEl.children).forEach(btn => {
    btn.setAttribute('aria-selected', btn.dataset.index == index ? 'true' : 'false');
  });
}

function nextSlide(){ showSlide(currentIndex + 1); }
function prevSlide(){ showSlide(currentIndex - 1); }

function startAutoRotate(){
  stopAutoRotate();
  carouselTimer = setInterval(()=> nextSlide(), AUTO_ROTATE_MS);
}
function stopAutoRotate(){ if(carouselTimer) clearInterval(carouselTimer); carouselTimer = null; }

/* events */
nextBtn.addEventListener('click', ()=> { nextSlide(); startAutoRotate(); });
prevBtn.addEventListener('click', ()=> { prevSlide(); startAutoRotate(); });

const carouselRoot = document.getElementById('ann-carousel');
carouselRoot.addEventListener('mouseenter', stopAutoRotate);
carouselRoot.addEventListener('mouseleave', startAutoRotate);
carouselRoot.addEventListener('focusin', stopAutoRotate);
carouselRoot.addEventListener('focusout', startAutoRotate);

document.addEventListener('keydown', (e)=>{
  if(document.activeElement && (document.activeElement.tagName === 'INPUT' || document.activeElement.tagName === 'TEXTAREA')) return;
  if(e.key === 'ArrowLeft') prevSlide();
  if(e.key === 'ArrowRight') nextSlide();
});

/* touch swipe */
(function addTouch(){
  let startX=0, dist=0;
  slidesEl.addEventListener('touchstart', e=> { startX = e.touches[0].clientX; stopAutoRotate(); }, {passive:true});
  slidesEl.addEventListener('touchmove', e=> { dist = e.touches[0].clientX - startX; }, {passive:true});
  slidesEl.addEventListener('touchend', e=>{
    if(dist > 40) prevSlide();
    else if(dist < -40) nextSlide();
    startAutoRotate();
    startX = 0; dist = 0;
  });
})();

/* search & refresh */
searchInput.addEventListener('input', (e)=>{
  const q = (e.target.value || '').trim().toLowerCase();
  if(!q) buildSlides(ANNOUNCEMENTS);
  else buildSlides(ANNOUNCEMENTS.filter(it => ((it.title||'') + ' ' + (it.desc||'')).toLowerCase().includes(q)));
});
refreshBtn.addEventListener('click', ()=> { loadAnnouncements(true); loadLinks(true); });

/* init */
loadLinks();
loadAnnouncements();

/* periodic refresh */
setInterval(()=>{ loadAnnouncements(true); loadLinks(true); }, 1000 * 60 * 5);

/* optional: SW registration stub */
if('serviceWorker' in navigator){
  navigator.serviceWorker?.register?.('/sw.js').catch(()=>{/* ignore */});
}
</script>
</body>
</html>